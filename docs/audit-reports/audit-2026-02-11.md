# Codebase Audit Report - 2026-02-11

**Commit**: `48159db` (main)
**Previous audit**: 2026-02-10 (`a40e701`)

---

## Executive Summary

The codebase has grown significantly since the initial baseline audits in January. The test suite is now a strong point with 53 test files, 958 test cases, and a 99.8% pass rate (950 passed, 8 skipped). TypeScript compilation is clean (zero errors). Error handler adoption in API routes has reached 81% (76/94 routes). The repository pattern is well-established with 12 repositories. The main areas needing attention are: (1) React hooks rules-of-hooks violations that represent actual runtime bugs, (2) over-large components that resist testing and maintenance, (3) console.log proliferation bypassing the structured Logger, and (4) API routes still lacking request body validation.

---

## Metrics Comparison

| Metric | 2026-01-07 | 2026-02-10 | 2026-02-11 | Delta (from prev) |
|--------|-----------|-----------|-----------|-------------------|
| TypeScript errors | 0 | 0 | 0 | -- |
| Lint errors | N/A | N/A | 42 | new metric |
| Lint warnings | N/A | N/A | 141 | new metric |
| Test files | 32 | 53 | 53 | 0 |
| Test cases | N/A | N/A | 958 | new metric |
| Tests passing | N/A | N/A | 950 | new metric |
| `as any` casts | 5 | 4 | 4 | 0 |
| Unsafe JSON.parse | 4 | 4 | 38* | +34* |
| console.log (source) | N/A | N/A | 148 | new metric |
| alert() usage | N/A | N/A | 27 | new metric |
| Largest file (lines) | 1113 | 769 | 1187 | +418 |
| Avg service lines | 218 | 226 | 239 | +13 |
| Singleton services | N/A | N/A | 41 | new metric |
| Repositories | 6 | 12 | 12 | 0 |
| API routes total | N/A | N/A | 94 | new metric |
| Routes with error handler | N/A | N/A | 76 (81%) | new metric |
| Routes without any validation | N/A | N/A | 69 (73%) | new metric |
| Open GitHub issues | N/A | N/A | 21 | new metric |
| Dependencies | N/A | N/A | 101 | new metric |

\* The unsafe JSON.parse metric was previously scoped to `lib/services/` only. The new count of 38 includes all source files (components, hooks, utils, server). The previous 4 in services remain unchanged.

---

## Qualitative Findings

### Critical

#### C1. React Hooks Rules-of-Hooks Violations (4 instances)
These are actual runtime bugs where React hooks are called conditionally, which can cause crashes or corrupted state.

**Files:**
- `components/dashboard/HeaderOverflowMenu.tsx:40` - `useLayoutPresets` called conditionally
- `components/quiz/host/QuizQuestionStage.tsx:110` - `React.useEffect` called conditionally (after early return)
- `components/shell/WorkspaceSelector.tsx:45-46` - Two `useState` calls behind a conditional

**Suggested fix:** Move all hook calls before any conditional returns. Extract conditional logic into child components if needed.

#### C2. Unimplemented Macro API Returns Fake Success
`app/api/actions/macro/route.ts` accepts requests and returns `{ success: true }` without actually executing anything. A user pressing a Stream Deck macro button would see success but nothing happens.

**Suggested fix:** Either implement the MacroEngine integration or return a 501 Not Implemented response with a clear message.

---

### High

#### H1. PosterCard Stale Closure in WebSocket Handler
`components/dashboard/cards/PosterCard.tsx:236` - The `localSeekTime` variable is captured in the `ws.onmessage` closure but the `useEffect` does not depend on it. This means the WebSocket handler always sees the initial value of `localSeekTime`, causing seek state to be overwritten by stale overlay data.

**Related issue:** GitHub #56

**Suggested fix:** Use a ref for `localSeekTime` or include it in the effect dependency array with proper cleanup.

#### H2. QuizStore Race Condition on Concurrent File Writes
`lib/services/QuizStore.ts:124,202,324` - Three different methods call `writeFile()` on the same session JSON file with no locking mechanism. Concurrent quiz events could cause data corruption.

**Related issue:** GitHub #54

**Suggested fix:** Add a write queue or mutex (e.g., `async-mutex` package, or a simple promise chain).

#### H3. Dashboard Cards Bypass useWebSocketChannel Hook
`components/dashboard/cards/GuestsCard.tsx` and `PosterCard.tsx` create raw `new WebSocket()` connections instead of using the shared `useWebSocketChannel` hook. This duplicates connection management, subscription logic, and reconnection handling.

**Related issue:** GitHub #51

**Suggested fix:** Migrate both cards to use `useWebSocketChannel` or `useMultiChannelWebSocket`.

#### H4. 69 API Routes Without Request Body Validation (73%)
Only 25 of 94 API routes perform any Zod schema validation on incoming request bodies. Routes accepting POST/PUT/PATCH data without validation are vulnerable to unexpected input shapes causing runtime errors.

**Key unvalidated routes:**
- `app/api/presenter/cue/send/route.ts` - Accepts presenter cue data without validation
- `app/api/quiz/session/create/route.ts` - Creates quiz sessions from unvalidated input
- `app/api/assets/posters/bulk/route.ts` - Bulk operations on poster data
- `app/api/overlays/lower/route.ts` - Lower third overlay control
- All Twitch moderation routes (`ban`, `timeout`, `message`)

**Suggested fix:** Create shared Zod schemas per resource type and validate in each route handler. The `withErrorHandler` wrapper already handles Zod errors gracefully.

---

### Medium

#### M1. 148 console.log Statements Bypass Logger (38 files)
The project has a structured `Logger` utility, but 148 `console.log` calls in 38 source files bypass it. This means no log levels, no structured output, and no file logging for those statements.

**Most affected areas:**
- `components/dashboard/cards/` (3 files)
- `hooks/` (2 files: `useWebSocketChannel.ts`, `useMultiChannelWebSocket.ts`)
- `server/` (2 files: `backend.ts`, `overlays.ts`)
- `streamdeck-plugin/` (7 files)
- Twitch integration (5 files)

**Related issue:** GitHub #62

**Suggested fix:** Replace with `Logger.getInstance()` calls with appropriate levels (debug/info/warn/error).

#### M2. 27 alert() Calls Instead of UI Notifications
Browser `alert()` is used in 27 places, primarily in quiz management components (`SessionManager.tsx`, `RoundEditor.tsx`, `QuestionEditor.tsx`) and settings (`PathSettings.tsx`, `BackupSettings.tsx`). These block the UI thread and provide no styling consistency.

**Related issue:** GitHub #70

**Suggested fix:** Replace with toast notifications (already used elsewhere via `sonner`).

#### M3. 5 Overlay Renderers Duplicate State/Ack Pattern
All 5 renderers (`LowerThirdRenderer`, `CountdownRenderer`, `PosterRenderer`, `BigPicturePosterRenderer`, `ChatHighlightRenderer`) implement the same boilerplate:
- `sendAckRef = useRef`
- `useEffect` to sync sendAck
- State management with `useState`
- Timeout cleanup patterns

**Related issue:** GitHub #59

**Suggested fix:** Extract a `useOverlayEventHandler` hook that encapsulates the sendAck ref pattern, state management, and timeout cleanup.

#### M4. Over-large Components Need Splitting (8 files > 500 lines)
Components that are too large are harder to test, review, and maintain.

| File | Lines |
|------|-------|
| `components/assets/ThemeManager.tsx` | 1,187 |
| `components/dashboard/cards/PosterCard.tsx` | 816 |
| `components/quiz/host/QuizQuestionStage.tsx` | 751 |
| `components/shell/panels/LowerThirdPanel.tsx` | 601 |
| `components/assets/PosterQuickAdd.tsx` | 600 |
| `components/dashboard/cards/LowerThirdCard.tsx` | 566 |
| `components/settings/TwitchSettings.tsx` | 518 |
| `components/overlays/LowerThirdDisplay.tsx` | 507 |

**Related issue:** GitHub #63

**Suggested fix:** Extract sub-components, custom hooks for state logic, and form sections into separate files.

#### M5. 18 API Routes Without Error Handler Wrapper
While 76 routes use `withErrorHandler` or `withSimpleErrorHandler`, 18 routes handle errors manually or not at all:
- `app/api/init/route.ts`
- `app/api/themes/route.ts` and `app/api/themes/[id]/route.ts`
- `app/api/updater/` (3 routes)
- `app/api/twitch/auth/` (3 routes)
- `app/api/profiles/[id]/activate/route.ts`
- And 8 others

**Related issue:** GitHub #61

**Suggested fix:** Wrap all remaining routes with `withSimpleErrorHandler` for consistent error response format.

#### M6. Test Worker Leak
Test suite reports: "A worker process has failed to exit gracefully and has been force exited." This indicates a test is not properly cleaning up timers or async operations, which can cause flaky CI and slow test runs.

**Suggested fix:** Run `pnpm test --detectOpenHandles` to identify the leaking test, then add proper teardown.

---

### Low

#### L1. 41 Singleton Services with Repeated Boilerplate
Every service class repeats the same `private static instance` / `getInstance()` pattern. While functional, this is ~8 lines of boilerplate per service (328 lines total).

**Related issue:** GitHub #65

**Suggested fix:** Consider a generic `Singleton<T>` helper or keep as-is (the pattern is well understood by the team).

#### L2. Lint Warnings: 21 Unescaped Entities
21 instances of unescaped `'` and `"` in JSX text. These are cosmetic but cause CI noise.

**Suggested fix:** Use HTML entities (`&apos;`, `&quot;`) or wrap in `{" "}` expressions.

#### L3. WikipediaCacheService Bypasses Repository Pattern
`lib/services/WikipediaCacheService.ts` uses direct SQL queries instead of going through a repository like other data access patterns.

**Related issue:** GitHub #68

#### L4. 8 TODO/FIXME/HACK Comments
Small count, but the most notable are:
- `app/api/actions/macro/route.ts:20` - "TODO: Implement macro execution via MacroEngine" (see C2)
- `components/dashboard/MacrosBar.tsx:13,21` - "TODO: Load from API" / "TODO: Implement macro execution"
- `server/api/quiz.ts:77` - "TODO: add viewerInputEnabled field to session"

#### L5. LLM Provider Model Hardcoding
`lib/services/llm/LLMProviderFactory.ts:38,76` hardcodes `claude-3-5-sonnet-20241022` as a fallback model. This will become stale as newer models are released.

**Suggested fix:** Move to `Constants.ts` or make configurable via settings.

---

## Scores

| Category | Previous (2026-02-10) | Current | Notes |
|----------|----------------------|---------|-------|
| Quality | 3.2 | 3.5 | Hooks violations found, but TS clean, better error handler adoption |
| Maintainability | 10.0 | 9.0 | ThemeManager.tsx grew to 1187 lines, avg service lines up |
| DRY | 9.7 | 9.5 | Dashboard card WS duplication persists, overlay renderer pattern |
| Tests | 0.0 | 7.5 | 958 test cases with 99.2% pass rate, but no coverage data |
| **Overall** | **5.7** | **7.4** | **+1.7** Significant improvement driven by test suite maturity |

---

## Action Items (Priority Order)

1. **Fix hooks rules violations** (C1) - These are actual bugs. 3 files, quick fixes.
2. **Fix PosterCard stale closure** (H1) - Use ref instead of captured variable.
3. **Add write queue to QuizStore** (H2) - Prevent data corruption.
4. **Return 501 for unimplemented macro endpoint** (C2) - Prevents user confusion.
5. **Add Zod validation to high-traffic API routes** (H4) - Start with presenter, quiz, overlay routes.
6. **Replace console.log with Logger** (M1) - 148 instances across 38 files.
7. **Replace alert() with toast** (M2) - 27 instances, mostly in quiz management.
8. **Migrate dashboard cards to useWebSocketChannel** (H3) - 2 cards to migrate.
9. **Wrap remaining 18 routes with error handler** (M5) - Consistent error handling.
10. **Extract overlay renderer shared hook** (M3) - Reduce duplication across 5 files.
11. **Split ThemeManager.tsx** (M4) - 1,187 lines is the largest component by far.
12. **Fix test worker leak** (M6) - Improve CI reliability.
